[AxForm]
Version=1
Size=286, 103
Title=

[AXControls]
Name=txtX
ProgID=VTCONTROLS.VTStaticText.1
Rect=12, 5, 178, 35
Style=50000000h
ID=123
Data=302 05 00 00 00 0f 00 00 80 00 03 52 e3 0b 91 8f ce 11 9d e3 00 aa 00 4b b8 51 01 00 00 00 90 01 44 42 01 00 06 54 61 68 6f 6d 61 0b 00 00 00 08 00 00 80 0f 00 00 80 0f 00 00 80 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 34 ce e1 e2 e5 e4 e8 f2 e5 20 f3 f7 e0 f1 f2 ea e8 20 f4 ee ed e0 0d 0a ed e0 20 e8 e7 ee e1 f0 e0 e6 e5 ed e8 e8 20 e8 20 ed e0 e6 ec e8 f2 e5 20 27 4f 6b 27 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff ff 00 00 00 00 00 00 00 00 49 4c 01 01 00 00 02 00 04 00 01 00 01 00 ff ff ff ff 10 00 ff ff ff ff ff ff ff ff 42 4d 36 00 00 00 00 00 00 00 36 00 00 00 28 00 00 00 04 00 00 00 01 00 00 00 01 00 10 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 6c 94 d8 81 0c b0 d2 81 01 00 00 00 01 00 00 00 0f 00 00 80 00 00 00 00 00 00 00 00 00 00 00 00

Name=Control2092
ProgID=VTDESIGN.VTD3DBarCtrl.1
Rect=12, 42, 274, 93
Style=50000000h
ID=0
Data=72 00 00 00 00 03 00 00 00 03 00 02 00 00 00 05 00 00 80 01 00 00 00 08 00 00 80 00 64 00 00 00 00 00 01 00 01 00 00 00 00 03 52 e3 0b 91 8f ce 11 9d e3 00 aa 00 4b b8 51 01 cc 00 00 90 01 44 42 01 00 05 41 72 69 61 6c

Name=txtBackgr
ProgID=VTCONTROLS.VTStaticText.1
Rect=153, 48, 212, 66
Style=50000000h
ID=0
Data=316 05 00 00 00 0f 00 00 80 00 03 52 e3 0b 91 8f ce 11 9d e3 00 aa 00 4b b8 51 01 00 00 00 90 01 44 42 01 00 06 54 61 68 6f 6d 61 0b 00 00 00 08 00 00 80 0f 00 00 80 0f 00 00 80 00 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 ff ff ff ff 00 00 00 00 00 00 00 00 49 4c 01 01 00 00 02 00 04 00 01 00 01 00 ff ff ff ff 11 00 ff ff ff ff ff ff ff ff 42 4d 36 00 00 00 00 00 00 00 36 00 00 00 28 00 00 00 04 00 00 00 01 00 00 00 01 00 10 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 42 4d 3e 00 00 00 00 00 00 00 3e 00 00 00 28 00 00 00 04 00 00 00 01 00 00 00 01 00 01 00 00 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff 00 00 00 00 00 01 00 00 00 01 00 00 00 0f 00 00 80 00 00 00 00 00 00 00 00 00 00 00 00

Name=chkAlways
ProgID=VTCHECKBOX.VTCheckBoxCtrl.1
Rect=27, 67, 260, 87
Style=50000000h
ID=0
Data=138 00 00 00 00 04 00 00 00 00 00 00 00 23 d3 ea e0 e7 fb e2 e0 f2 fc 20 f4 ee ed 20 ed e0 20 ea e0 e6 e4 ee ec 20 e8 e7 ee e1 f0 e0 e6 e5 ed e8 e8 08 00 00 80 0f 00 00 80 08 00 00 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 03 52 e3 0b 91 8f ce 11 9d e3 00 aa 00 4b b8 51 01 00 00 00 90 01 44 42 01 00 06 54 61 68 6f 6d 61

Name=txtBackgrCaption
ProgID=VTCONTROLS.VTStaticText.1
Rect=30, 49, 145, 63
Style=50000000h
ID=0
Data=338 05 00 00 00 0f 00 00 80 00 03 52 e3 0b 91 8f ce 11 9d e3 00 aa 00 4b b8 51 01 00 00 00 90 01 44 42 01 00 06 54 61 68 6f 6d 61 0b 00 00 00 08 00 00 80 0f 00 00 80 0f 00 00 80 00 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 16 42 61 63 6b 67 72 6f 75 6e 64 20 62 72 69 67 68 74 6e 65 73 73 3a 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff ff 00 00 00 00 00 00 00 00 49 4c 01 01 00 00 02 00 04 00 01 00 01 00 ff ff ff ff 11 00 ff ff ff ff ff ff ff ff 42 4d 36 00 00 00 00 00 00 00 36 00 00 00 28 00 00 00 04 00 00 00 01 00 00 00 01 00 10 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 42 4d 3e 00 00 00 00 00 00 00 3e 00 00 00 28 00 00 00 04 00 00 00 01 00 00 00 01 00 01 00 00 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff 00 00 00 00 00 01 00 00 00 01 00 00 00 0f 00 00 80 00 00 00 00 00 00 00 00 00 00 00 00

Name=btnDel
ProgID=PUSHBUTTON.PushButtonCtrl.1
Rect=179, 9, 272, 31
Style=50000000h
ID=3101
Data=155 0c 01 00 01 00 00 00 00 00 00 00 01 00 01 00 01 00 00 00 00 0e ce f2 ec e5 ed e8 f2 fc 20 e2 fb e1 ee f0 00 00 05 00 05 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 14 04 01 01 16 00 00 00 68 00 00 00 04 00 00 00 00 03 52 e3 0b 91 8f ce 11 9d e3 00 aa 00 4b b8 51 01 00 00 00 90 01 44 42 01 00 06 54 61 68 6f 6d 61 00 00 00 00 00 00 00 00 00 05 00 00 80 08 00 00 80 08 00 00 80 08 00 00 80 08 00 00 80 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 01 00


[Script]
blnWasFrame = False
blnWasNotOldBack = True

Dim gl_Script

'***************************************************************
'Form event handlers.
'***************************************************************
Sub Form_OnInitialize()
	Set gl_Script = Application.GetGlobalScript("")
	Dim objActiveImage, objParentImg

	txtX.Text = Docs.LoadString ("Specify areas of background\non the image and click OK")
	btnDel.ButtonText = Docs.LoadString ("Clear All")
	txtBackgrCaption.Text = Docs.LoadString ("Background brightness:") 
	chkAlways.Caption = Docs.LoadString ("Specify background on every image")

	ActionManager.HideDockBars

	Set objActiveImage = Objects.ActiveImage
	If Not Docs.IsPointerNull(objActiveImage) Then
		Set objParentImg = objActiveImage.GetParent
		If Not Docs.IsPointerNull(objParentImg) Then
			Objects.SetObjectActive objParentImg
		End If
	End If

	chkAlways.Checked Data.GetDefValue ("\ODensity\RunSettingsOnEachPass", 0)

	btnDel.Disabled = True

	iBack = Data.GetDefValue ("\ODensity\Backgr", -1)
	If iBack = -1 Then
		txtBackgr.Text = "---"
		FormManager.EnableOk False
	Else
		txtBackgr.Text = iBack
		FormManager.EnableOk True
	End If

	ActionState.TerminateCurrentAction

'	ActionManager.SelectAdd 1
'	ActionManager.SelectArea
End Sub

Sub Form_OnOK()
	Data.SetValue "\tmp\ODSetBackgr1", 0

	Data.SetValue "\ODensity\RunSettingsOnEachPass", Abs(chkAlways.Checked)

	Set objNewImage = Objects.ActiveImage
	Set objParentImg = objNewImage.GetParent
	If Docs.IsPointerNull(objParentImg) Then
		Exit Sub
	End If

	OpticMeasure.Free
	Data.RemoveValue "\ODensity"

	OpticMeasure.Method = 0
	intBright = OpticMeasure.CalkAvgBack(objNewImage)
	Data.Setvalue "\ODensity\Method", 0
	Data.Setvalue "\ODensity\Backgr", intBright
End Sub

Sub Form_OnCancel()
	Data.SetValue "\tmp\ODSetBackgr1", 0
End Sub

Sub Form_OnDestroy()
'Exit Sub
	ActionState.TerminateCurrentAction
	ActionManager.ShowDockBars
'	ActionManager.SelectAdd 0

'	ODBarPos = Toolbars.FindDockNo("ODensitySettings")
'	Toolbars.ShowDockBar ODBarPos, True
	Set objNewImage = Objects.ActiveImage
	Set objParentImg = objNewImage.GetParent
	If Not Docs.IsPointerNull(objParentImg) Then
		Objects.RemoveObject objNewImage
	End If
	Set gl_Script = Nothing
End Sub


'***************************************************************
'btnDel event handlers.
'***************************************************************
Sub btnDel_Click()
	Set objActiveImage = Objects.ActiveImage
	Set objParentImg = objActiveImage.GetParent
	If TypeName(objParentImg) <> "Nothing" Then
		txtImgName = objActiveImage.Name
		txtParentName = objParentImg.Name
		If txtImgName <> txtParentName And txtImgName <> "" And txtParentName <> "" Then
			Objects.RemoveObject objActiveImage
			Objects.SetObjectActive objParentImg
		End If
	End If
	ActionState.TerminateCurrentAction
'	ActionManager.SelectAdd 1
'	ActionManager.SelectArea
	txtBackgr.Text = "---"
	FormManager.EnableOk False
	btnDel.Disabled = True
End Sub

Sub ActionState_OnActionComplete(strActionName, intActionResult)
	If strActionName = "SelectArea" And intActionResult = 1 Then
		Objects.ActiveImage.CalcMinMaxBrightness
		txtBackgr.Text = Objects.ActiveImage.GetAverageBrightness
		FormManager.EnableOk True
		btnDel.Disabled = False
		'MsgBox OpticMeasure.CalkAvgBack(Objects.ActiveImage)
	End If
End Sub